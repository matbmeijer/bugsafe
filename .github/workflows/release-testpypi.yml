name: Release to TestPyPI

on:
    workflow_dispatch:
        inputs:
            version:
                description: "Version to release (e.g., 0.1.0)"
                required: true
                type: string

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v4
              with:
                  version: "latest"

            - name: Set up Python
              run: uv python install 3.12

            - name: Install dependencies
              run: uv sync --all-extras

            - name: Run tests
              run: uv run pytest tests/ -v

            - name: Run linters
              run: |
                  uv run mypy src/
                  uv run ruff check src/

            - name: Build package
              run: uv build

            - name: Verify package locally
              run: |
                  pip install dist/*.whl
                  bugsafe --version

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist/

    publish:
        needs: build
        runs-on: ubuntu-latest
        environment: testpypi
        permissions:
            id-token: write
        steps:
            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  name: dist
                  path: dist/

            - name: Publish to TestPyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  repository-url: https://test.pypi.org/legacy/

    verify:
        needs: publish
        runs-on: ubuntu-latest
        steps:
            - name: Wait for TestPyPI indexing
              run: sleep 60

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install from TestPyPI
              run: |
                  pip install --index-url https://test.pypi.org/simple/ \
                    --extra-index-url https://pypi.org/simple/ \
                    bugsafe==${{ github.event.inputs.version }}

            - name: Verify installation
              run: |
                  bugsafe --version
                  bugsafe --help
